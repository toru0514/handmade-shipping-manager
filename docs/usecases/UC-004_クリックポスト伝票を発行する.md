# UC-004: クリックポスト伝票を発行する

## 基本情報

| 項目 | 内容 |
|-----|------|
| ユースケースID | UC-004 |
| ユースケース名 | クリックポスト伝票を発行する |
| アクター | 作家 |
| 優先度 | 高 |
| ステータス | 未実装 |

## 概要

クリックポスト（日本郵便）の伝票PDFを、購入者情報を自動入力した状態で発行する。
クリックポストはAPIを提供していないため、Playwrightによるブラウザ自動操作で実現する。

## 事前条件

- 作家がアプリにアクセスしていること
- 対象の注文が「発送前」ステータスであること
- クリックポストのアカウント情報が設定されていること
- Amazonアカウントでログイン可能であること

## 事後条件

- クリックポストの伝票PDFがダウンロードされている
- ShippingLabel（ClickPostLabel）が発行され保存されている

## 基本フロー

1. 作家は発送前注文一覧（UC-003）から対象注文の「クリックポスト」ボタンをクリックする
2. システムは注文情報を取得する
3. システムはPlaywrightでクリックポストサイトを開く
4. システムはAmazonアカウントでログインする（セッションが有効な場合はスキップ）
5. システムは「1件申込」画面に遷移する
6. システムは以下の情報を自動入力する：
   - お届け先郵便番号
   - お届け先住所
   - お届け先氏名
   - 内容品
7. システムは「次へ」ボタンをクリックする
8. システムは確認画面で内容を確認する
9. システムは「支払い手続きをする」をクリックする
10. システムはAmazon Payで決済処理を行う
11. システムは伝票PDFをダウンロードする
12. システムはPDFファイルを作家に提供する（ダウンロード or 表示）
13. システムはShippingLabel（ClickPostLabel）を保存する

## 代替フロー

### 4a. ログインセッションが切れている場合
1. システムはログイン画面を検出する
2. システムはユーザーにログインを促すか、保存された認証情報でログインする

### 6a. 住所入力でエラーが発生した場合
1. システムはエラー内容を表示する
2. 作家は住所を手動で修正できる

### 9a. 決済をスキップする場合（確認のみ）
1. 作家は「確認のみ」オプションを選択できる
2. システムは決済手前で停止する
3. 作家は手動で決済を完了する

### 10a. 決済に失敗した場合
1. システムはエラーを検出する
2. システムは作家にエラー内容を通知する
3. 注文ステータスは「発送前」のまま

## 関連ドメインルール

このユースケースで適用されるドメインルール（[詳細](../domain/README.md#ドメインルールdomain-rules)）:

| ルールID | ルール名 | 説明 |
|---------|---------|------|
| DR-LBL-002 | 発送前のみ発行可 | 発送済み注文には伝票を発行できない |
| DR-LBL-003 | 重複発行警告 | 同一注文に対する伝票の重複発行は警告を表示 |
| DR-SHP-002 | クリックポスト重量制限 | 1kg以下の荷物のみ対応（警告表示） |

### アプリケーションルール

- 1日の発行上限を超える場合は警告を表示する
- 伝票発行後のキャンセルはシステム外で行う

## 非機能要件

- Playwright処理は30秒以内に完了する（決済除く）
- PDFダウンロードは5秒以内

## 技術的考慮事項

### Playwright実装

```typescript
// 概念的なコード例
const clickpostAutomation = async (order: Order) => {
  const browser = await chromium.launch({ headless: false });
  const page = await browser.newPage();

  // クリックポストにアクセス
  await page.goto('https://clickpost.jp/');

  // ログイン処理
  await handleAmazonLogin(page);

  // 申込画面に遷移
  await page.click('text=1件申込');

  // 住所入力
  await page.fill('#postal-code', order.buyerPostalCode);
  await page.fill('#address', order.fullAddress);
  await page.fill('#name', order.buyerName);
  await page.fill('#contents', order.productName);

  // 確認・決済処理
  // ...

  // PDF取得
  const pdfBuffer = await downloadPDF(page);

  await browser.close();
  return pdfBuffer;
};
```

### 認証情報の管理

- Amazonアカウントの認証情報は環境変数または暗号化されたストレージに保存
- セッションCookieを保持し、再ログインを最小化

## 画面・UI

### 伝票発行ダイアログ

```
┌─────────────────────────────────────────────────────┐
│ 📮 クリックポスト伝票発行                            │
├─────────────────────────────────────────────────────┤
│                                                     │
│  注文番号: ORD-2024-001234                          │
│  購入者: 山田 太郎 様                               │
│  住所: 〒100-0001                                   │
│        東京都千代田区千代田1-1-1                     │
│  内容品: ハンドメイドアクセサリー                    │
│                                                     │
│  ─────────────────────────────────────────────────  │
│                                                     │
│  処理オプション:                                    │
│  ○ 決済まで自動実行                                │
│  ○ 確認画面で停止（手動決済）                       │
│                                                     │
│  ─────────────────────────────────────────────────  │
│                                                     │
│  [キャンセル]                    [伝票を発行する]   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 処理中画面

```
┌─────────────────────────────────────────────────────┐
│ 📮 クリックポスト伝票発行中...                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│     ⏳ 処理中です。しばらくお待ちください...         │
│                                                     │
│     ✓ クリックポストにログイン                      │
│     ✓ 申込画面に移動                               │
│     ▶ 住所情報を入力中...                          │
│     ○ 確認画面                                     │
│     ○ 決済処理                                     │
│     ○ PDF取得                                      │
│                                                     │
│  [処理を中断する]                                   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## データ

### 入力データ
- 注文情報（UC-003から引き継ぎ）

### 出力データ
- クリックポスト伝票PDF
- 更新された注文ステータス

## 関連ユースケース

- UC-003: 発送前注文一覧を表示する（先行ユースケース）
- UC-006: 発送完了を記録する（後続ユースケース）

## 備考

- Playwrightはヘッドレスモードでも動作するが、初回は画面確認のためヘッドフルモードを推奨
- Amazonアカウントの2段階認証に対応が必要
- クリックポストのUI変更に追従するメンテナンスが必要
- 将来的にはバッチ処理（複数件一括発行）も検討
