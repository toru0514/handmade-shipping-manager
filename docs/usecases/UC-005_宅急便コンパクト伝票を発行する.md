# UC-005: 宅急便コンパクト伝票を発行する

## 基本情報

| 項目 | 内容 |
|-----|------|
| ユースケースID | UC-005 |
| ユースケース名 | 宅急便コンパクト伝票を発行する |
| アクター | 作家 |
| 優先度 | 高 |
| ステータス | 未実装 |

## 概要

ヤマト運輸の宅急便コンパクトの伝票（PUDO用QRコード）を、購入者情報を自動入力した状態で発行する。
ヤマト運輸はAPIを提供していないため、Playwrightによるブラウザ自動操作で実現する。

## 事前条件

- 作家がアプリにアクセスしていること
- 対象の注文が「発送前」ステータスであること
- ヤマト運輸のクロネコメンバーズアカウント情報が設定されていること
- 送り状発行システム（C2C）へのアクセス権があること

## 事後条件

- PUDOで使用可能なQRコードが発行されている
- （オプション）注文ステータスが「伝票発行済み」に更新されている

## 基本フロー

1. 作家は発送前注文一覧（UC-003）から対象注文の「宅急便コンパクト」ボタンをクリックする
2. システムは注文情報を取得する
3. システムはPlaywrightでヤマト運輸のサイトを開く
4. システムはクロネコメンバーズアカウントでログインする（セッションが有効な場合はスキップ）
5. システムは「送り状発行」画面に遷移する
6. システムは「宅急便コンパクト」を選択する
7. システムは以下の情報を自動入力する：
   - お届け先郵便番号
   - お届け先住所
   - お届け先氏名
   - お届け先電話番号
   - 品名
8. システムは発払い/着払いを選択する（デフォルト：発払い）
9. システムは「PUDO」を発送方法として選択する
10. システムは内容を確認し、送り状を発行する
11. システムはQRコードを取得する（スクリーンショットまたはQRコードデータ）
12. システムはQRコードを作家に提供する（表示 or ダウンロード）
13. システムは注文ステータスを「伝票発行済み」に更新する

## 代替フロー

### 4a. ログインセッションが切れている場合
1. システムはログイン画面を検出する
2. システムはユーザーにログインを促すか、保存された認証情報でログインする

### 7a. 住所入力でエラーが発生した場合
1. システムはエラー内容を表示する
2. 作家は住所を手動で修正できる

### 9a. コンビニ発送を選択する場合
1. 作家は「コンビニ発送」オプションを選択できる
2. システムは最寄りのコンビニを表示する
3. 作家は発送先コンビニを選択する

### 11a. QRコード取得に失敗した場合
1. システムは送り状番号を記録する
2. 作家はヤマト運輸のマイページからQRコードを確認できる

## ビジネスルール

- BR-001: 宅急便コンパクトのサイズ制限（専用BOX使用）を事前に確認する
- BR-002: 配送料金は送り状発行時に確定する
- BR-003: QRコードの有効期限は発行から14日間

## 非機能要件

- Playwright処理は30秒以内に完了する
- QRコード取得は5秒以内

## 技術的考慮事項

### Playwright実装

```typescript
// 概念的なコード例
const yamotoCompactAutomation = async (order: Order) => {
  const browser = await chromium.launch({ headless: false });
  const page = await browser.newPage();

  // ヤマト運輸にアクセス
  await page.goto('https://www.kuronekoyamato.co.jp/');

  // クロネコメンバーズログイン
  await handleKuronekoLogin(page);

  // 送り状発行画面に遷移
  await page.click('text=送り状を発行する');

  // 宅急便コンパクトを選択
  await page.click('text=宅急便コンパクト');

  // 住所入力
  await page.fill('#postal-code', order.buyerPostalCode);
  await page.fill('#address', order.fullAddress);
  await page.fill('#name', order.buyerName);
  await page.fill('#phone', order.buyerPhone);
  await page.fill('#product-name', order.productName);

  // PUDO選択
  await page.click('text=PUDO');

  // 発行処理
  await page.click('text=送り状を発行');

  // QRコード取得
  const qrCode = await captureQRCode(page);

  await browser.close();
  return qrCode;
};
```

### 認証情報の管理

- クロネコメンバーズの認証情報は環境変数または暗号化されたストレージに保存
- セッションCookieを保持し、再ログインを最小化

## 画面・UI

### 伝票発行ダイアログ

```
┌─────────────────────────────────────────────────────┐
│ 📦 宅急便コンパクト伝票発行                          │
├─────────────────────────────────────────────────────┤
│                                                     │
│  注文番号: ORD-2024-001234                          │
│  購入者: 山田 太郎 様                               │
│  住所: 〒100-0001                                   │
│        東京都千代田区千代田1-1-1                     │
│  電話番号: 090-1234-5678                            │
│  品名: ハンドメイドアクセサリー                      │
│                                                     │
│  ─────────────────────────────────────────────────  │
│                                                     │
│  発送方法:                                          │
│  ● PUDO（宅配便ロッカー）                           │
│  ○ コンビニ発送                                    │
│  ○ ヤマト営業所持込                                │
│                                                     │
│  支払い方法:                                        │
│  ● 発払い（元払い）                                │
│  ○ 着払い                                          │
│                                                     │
│  ─────────────────────────────────────────────────  │
│                                                     │
│  [キャンセル]                    [伝票を発行する]   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### QRコード表示画面

```
┌─────────────────────────────────────────────────────┐
│ ✅ QRコードが発行されました                          │
├─────────────────────────────────────────────────────┤
│                                                     │
│              ┌─────────────────┐                    │
│              │                 │                    │
│              │    [QRコード]    │                    │
│              │                 │                    │
│              └─────────────────┘                    │
│                                                     │
│  送り状番号: 1234-5678-9012                         │
│  有効期限: 2024/01/29                               │
│                                                     │
│  📱 このQRコードをPUDOの端末にかざしてください       │
│                                                     │
│  ─────────────────────────────────────────────────  │
│                                                     │
│  [ダウンロード]  [スマホに送信]  [閉じる]            │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## データ

### 入力データ
- 注文情報（UC-003から引き継ぎ）
- 発送オプション（PUDO/コンビニ/営業所）

### 出力データ
- PUDOQRコード（画像）
- 送り状番号
- 更新された注文ステータス

## 関連ユースケース

- UC-003: 発送前注文一覧を表示する（先行ユースケース）
- UC-006: 発送完了を記録する（後続ユースケース）

## 備考

- ヤマト運輸のサイトUIは頻繁に変更されるため、定期的なメンテナンスが必要
- クロネコメンバーズの2段階認証に対応が必要
- QRコードはスマートフォンに直接送信する機能も検討
- 将来的にはバッチ処理（複数件一括発行）も検討
- 宅急便コンパクトの専用BOXの在庫管理機能も将来的に検討
