# UC-009: 発送連絡メッセージを作成する

## 基本情報

| 項目 | 内容 |
|-----|------|
| ユースケースID | UC-009 |
| ユースケース名 | 発送連絡メッセージを作成する |
| アクター | 作家 |
| 優先度 | 高 |
| ステータス | 未実装 |

## 概要

発送完了時に、購入者へ送る発送連絡メッセージを定型文ベースで自動生成し、コピーしやすい形で表示する。

## 事前条件

- 注文がスプレッドシートに登録されていること
- 発送方法が決定していること（クリックポスト or 宅急便コンパクト）
- 発送連絡の定型文が設定されていること（UC-010）

## 事後条件

- 発送連絡メッセージが生成され、画面に表示されている
- メッセージがクリップボードにコピー可能な状態になっている

## 基本フロー

1. 作家は発送完了記録（UC-006）の完了後、「発送連絡メッセージ」ボタンをクリックする
2. システムは注文情報と発送情報を取得する
3. システムは以下の情報を定型文に埋め込む：
   - 購入者名
   - 発送方法（クリックポスト / 宅急便コンパクト）
   - （オプション）追跡番号
   - （オプション）追跡URL
4. システムは生成されたメッセージをダイアログで表示する
5. 作家は「コピー」ボタンをクリックする
6. システムはメッセージをクリップボードにコピーする
7. 作家はminne/creemaのメッセージ機能に貼り付けて送信する

## 代替フロー

### 1a. 発送完了時に自動表示する場合
1. UC-006完了後、システムは自動的に発送連絡メッセージダイアログを表示する
2. 基本フロー4へ続く

### 4a. メッセージを編集する場合
1. 作家は生成されたメッセージを編集できる
2. 編集後、「コピー」ボタンをクリックする

### 4b. 定型文を変更したい場合
1. 作家は「定型文を編集」リンクをクリックする
2. システムは定型文設定画面（UC-010）へ遷移する

## 関連ドメインルール

このユースケースで適用されるドメインルール（[詳細](../domain/README.md#ドメインルールdomain-rules)）:

| ルールID | ルール名 | 説明 |
|---------|---------|------|
| DR-MSG-001 | 空テンプレート禁止 | テンプレートは空にできない |
| DR-MSG-002 | 変数必須 | テンプレートは最低1つの変数を含む必要がある |
| DR-SHP-001 | 対応配送方法 | クリックポスト / 宅急便コンパクト のみ対応 |

### アプリケーションルール

- 定型文は設定画面（UC-010）で編集可能
- 発送方法は変数として定型文に埋め込む
- 追跡番号・追跡URLがある場合は自動的に追加

## 非機能要件

- メッセージ生成は即時（1秒以内）
- クリップボードコピーは確実に動作すること

## 画面・UI

### 発送連絡メッセージダイアログ

```
┌─────────────────────────────────────────────────────────────────┐
│ 📦 発送連絡メッセージ                          [定型文を編集]    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  注文: ORD-2024-001234 (minne)                                  │
│  購入者: 山田 太郎 様                                           │
│  発送方法: クリックポスト                                        │
│  追跡番号: 1234-5678-9012-3456                                  │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 山田 太郎 様                                             │   │
│  │                                                         │   │
│  │ お待たせいたしました。                                   │   │
│  │ 本日、クリックポストにて発送いたしました。                │   │
│  │                                                         │   │
│  │ 追跡番号: 1234-5678-9012-3456                           │   │
│  │ 追跡URL: https://trackings.post.japanpost.jp/...         │   │
│  │                                                         │   │
│  │ 届きましたら、ご確認をお願いいたします。                  │   │
│  │                                                         │   │
│  │ この度はご購入いただき、ありがとうございました。          │   │
│  │ またのご利用を心よりお待ちしております。                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  [編集する]                          [コピー 📋]  [閉じる]       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 発送完了後の表示

```
┌─────────────────────────────────────────────────────────────────┐
│ 🎉 発送完了                                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  注文 ORD-2024-001234 を発送済みにしました。                     │
│                                                                 │
│  発送日時: 2024/01/15 15:30                                     │
│  配送方法: クリックポスト                                        │
│  追跡番号: 1234-5678-9012-3456                                  │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  [発送連絡メッセージをコピー 📋]                 [閉じる]        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 定型文テンプレート

### デフォルトテンプレート

```
{{buyer_name}} 様

お待たせいたしました。
本日、{{shipping_method}}にて発送いたしました。

{{#if tracking_number}}
追跡番号: {{tracking_number}}
追跡URL: {{tracking_url}}
{{/if}}

届きましたら、ご確認をお願いいたします。

この度はご購入いただき、ありがとうございました。
またのご利用を心よりお待ちしております。
```

### 利用可能な変数

| 変数 | 説明 | 例 |
|-----|------|-----|
| `{{buyer_name}}` | 購入者名 | 山田 太郎 |
| `{{shipping_method}}` | 発送方法 | クリックポスト / 宅急便コンパクト |
| `{{tracking_number}}` | 追跡番号 | 1234-5678-9012-3456 |
| `{{tracking_url}}` | 追跡URL（発送方法に応じて自動生成） | https://trackings.post.japanpost.jp/... |
| `{{shipped_at}}` | 発送日時 | 2024/01/15 |
| `{{product_name}}` | 商品名 | ハンドメイドアクセサリー |

### 追跡URLの自動生成

| 発送方法 | 追跡URL |
|---------|---------|
| クリックポスト | `https://trackings.post.japanpost.jp/services/srv/search/?requestNo1={追跡番号}` |
| 宅急便コンパクト | `https://toi.kuronekoyamato.co.jp/cgi-bin/tneko?number={追跡番号}` |

## データ

### 入力データ
- 注文情報
- 発送情報（発送方法、追跡番号）
- 定型文テンプレート（UC-010で設定）

### 出力データ
- 生成された発送連絡メッセージ（テキスト）

## 関連ユースケース

- UC-006: 発送完了を記録する（発送完了後に実行）
- UC-004: クリックポスト伝票を発行する（追跡番号取得元）
- UC-005: 宅急便コンパクト伝票を発行する（追跡番号取得元）
- UC-010: 定型文を設定する（テンプレート設定）

## 備考

- 発送方法は変数`{{shipping_method}}`で埋め込み、テンプレートは1つで管理
- 追跡URLは発送方法に応じてシステムが自動生成し、`{{tracking_url}}`に設定
- 将来的にはAIによるパーソナライズメッセージ生成も検討
- メッセージ送信履歴の記録も将来的に検討
- プラットフォームのAPI対応があれば自動送信も検討
