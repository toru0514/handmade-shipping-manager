# UC-001: 購入情報を取得する

## 基本情報

| 項目 | 内容 |
|-----|------|
| ユースケースID | UC-001 |
| ユースケース名 | 購入情報を取得する |
| アクター | システム |
| 優先度 | 高 |
| ステータス | 未実装 |

## 概要

Gmailに届いたハンドメイドプラットフォーム（minne、creemaなど）からの購入通知メールを監視し、購入情報を抽出してスプレッドシートに記録する。

## 事前条件

- Gmail APIが有効化されていること
- Google Sheets APIが有効化されていること
- 対象となるハンドメイドプラットフォームのアカウントが設定されていること
- スプレッドシートが作成済みであること

## 事後条件

- 購入情報がスプレッドシートに記録されている
- 注文ステータスが「発送前」として登録されている

## 基本フロー

1. システムは定期的にGmailをポーリングする（または Gmail Push Notification を受信する）
2. システムは購入通知メールを検出する
3. システムはメール本文から以下の情報を抽出する：
   - 注文番号
   - 購入者名
   - 購入者住所（郵便番号、都道府県、市区町村、番地、建物名）
   - 購入者電話番号
   - 購入品名
   - 購入金額
   - 購入日時
   - プラットフォーム名（minne / creema）
4. システムは抽出した情報をスプレッドシートに新規行として追加する
5. システムは注文ステータスを「発送前」に設定する

## 代替フロー

### 3a. メールのパースに失敗した場合
1. システムはエラーログを記録する
2. システムは管理者にSlackで通知する
3. メールは「要確認」としてマークされる

### 4a. 重複する注文番号が存在する場合
1. システムは重複を検出する
2. システムは新規追加をスキップする
3. システムはログに重複スキップを記録する

## ビジネスルール

- BR-001: 同一注文番号の購入情報は重複登録しない
- BR-002: minne、creema以外のプラットフォームからのメールは処理対象外とする
- BR-003: 購入日時はメール受信日時ではなく、メール本文に記載された日時を使用する

## 非機能要件

- メール取得の間隔は5分以内とする
- メール処理は1件あたり3秒以内に完了する

## 画面・UI

このユースケースはバックグラウンド処理のため、画面は存在しない。

## データ

### 入力データ
- Gmailの購入通知メール

### 出力データ（スプレッドシート）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| order_id | string | 注文番号 |
| platform | string | プラットフォーム名 |
| buyer_name | string | 購入者名 |
| buyer_postal_code | string | 郵便番号 |
| buyer_prefecture | string | 都道府県 |
| buyer_city | string | 市区町村 |
| buyer_address1 | string | 番地 |
| buyer_address2 | string | 建物名（任意） |
| buyer_phone | string | 電話番号 |
| product_name | string | 購入品名 |
| price | number | 購入金額 |
| ordered_at | datetime | 購入日時 |
| status | string | ステータス（発送前/発送済み） |
| created_at | datetime | 登録日時 |
| updated_at | datetime | 更新日時 |

## 関連ユースケース

- UC-002: 新規注文を通知する（本ユースケース完了後に実行）

## 備考

- Gmail APIの代わりにGoogle Apps Scriptを使用する選択肢もある
- 将来的にはWebhook対応のプラットフォームがあれば、直接連携も検討
